
<!-- PLACEHOLDER: original full HTML file goes here with all UI intact -->
<!-- INSERT THIS SCRIPT AT THE BOTTOM of <script> section or replace the existing data loading logic -->

// Auto-load driver data from GitHub on page load
async function loadDriverDataFromGitHub() {
  try {
    const response = await fetch("https://wzmwwjkl.github.io/driver-payment-system/docs/drivers.xlsx");
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: "array" });

    const sheetName = workbook.SheetNames.find(name =>
      name.toLowerCase().includes("driver")
    );

    if (!sheetName) {
      console.error("Driver sheet not found in Excel file");
      return;
    }

    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);

    if (jsonData.length === 0) {
      console.error("Driver sheet is empty");
      return;
    }

    const drivers = [];
    const firstRow = jsonData[0];
    const columnMap = {};
    Object.keys(firstRow).forEach(key => {
      const normalizedKey = key.toLowerCase().trim();
      columnMap[normalizedKey] = key;
    });

    jsonData.forEach(row => {
      const idRaw = row[columnMap["driver_id"]];
      if (!idRaw) return;

      const driverId = String(idRaw).split(".")[0]; // Strip decimals
      if (driverId === "绿宝") return;

      let driverName = row[columnMap["driver_name"]] || "";
      const dotIndex = driverName.indexOf(".");
      if (dotIndex !== -1) {
        driverName = driverName.substring(dotIndex + 1);
      }

      const totalOrders = parseInt(row[columnMap["total_order_cnt"]]) || 0;
      const sameAddressOrders = parseInt(row[columnMap["rest_order_cnt"]]) || 0;

      const deduction = 0;
      const regularRate = appData.regularRate;

      drivers.push({
        id: driverId,
        name: driverName,
        total_order_cnt: totalOrders,
        rest_order_cnt: sameAddressOrders,
        deduction: deduction,
        regularRate: regularRate
      });
    });

    if (drivers.length === 0) {
      console.error("No valid driver data found in file");
      return;
    }

    appData.drivers = drivers;
    console.log("Driver data loaded from GitHub:", drivers.length);
    renderDriversTable();
  } catch (err) {
    console.error("Failed to load data:", err);
  }
}

// Load data from GitHub when page loads
loadDriverDataFromGitHub();

