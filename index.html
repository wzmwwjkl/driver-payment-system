<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Driver Payment System</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí≥</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Add your full original body content (UI layout, tabs, forms, etc.) here -->

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const appData = {
        drivers: [],
        sameAddressRate: 0.5,
        regularRate: 2.0,
        currentPage: 1,
        driversPerPage: 15
      };
      window.appData = appData;

      const DATA_URL = "https://wzmwwjkl.github.io/driver-payment-system/docs/drivers.xlsx";

      async function loadDriverDataFromGitHub() {
        try {
          const response = await fetch(DATA_URL);
          const arrayBuffer = await response.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });

          const sheetName = workbook.SheetNames.find(name =>
            name.toLowerCase().includes('driver')
          );

          if (!sheetName) {
            console.error('Driver sheet not found in Excel file');
            return;
          }

          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);

          if (jsonData.length === 0) {
            console.error('Driver sheet is empty');
            return;
          }

          const drivers = [];
          const firstRow = jsonData[0];
          const columnMap = {};
          Object.keys(firstRow).forEach(key => {
            const normalizedKey = key.toLowerCase().trim();
            columnMap[normalizedKey] = key;
          });

          jsonData.forEach(row => {
            if (!('driver_id' in columnMap) || !row[columnMap.driver_id]) return;
            const driverId = row[columnMap.driver_id];
            if (driverId === 'ÁªøÂÆù') return;

            let driverName = '';
            if ('driver_name' in columnMap) {
              driverName = row[columnMap.driver_name];
              const dotIndex = driverName.indexOf('.');
              if (dotIndex !== -1) {
                driverName = driverName.substring(dotIndex + 1);
              }
            }

            const totalOrders = 'total_order_cnt' in columnMap ?
              parseInt(row[columnMap.total_order_cnt]) || 0 : 0;

            const sameAddressOrders = 'rest_order_cnt' in columnMap ?
              parseInt(row[columnMap.rest_order_cnt]) || 0 : 0;

            const deduction = 0;
            const regularRate = appData.regularRate;

            drivers.push({
              id: driverId,
              name: driverName,
              total_order_cnt: totalOrders,
              rest_order_cnt: sameAddressOrders,
              deduction: deduction,
              regularRate: regularRate
            });
          });

          if (drivers.length === 0) {
            console.error('No valid driver data found in file');
            return;
          }

          appData.drivers = drivers;
          alert(`Loaded ${drivers.length} drivers from GitHub`);
        } catch (err) {
          console.error("Failed to load data:", err);
        }
      }

      loadDriverDataFromGitHub();
    });
  </script>
</body>
</html>
